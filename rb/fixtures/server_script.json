[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-14 22:12:28.996942",
  "module": "rb",
  "name": "sync arrangement to evacuees",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "if doc.evacuee_a:\n    evacuee_1 = frappe.get_doc(\"Evacuee\", doc.evacuee_a)\n    evacuee_1.arrangement_file = doc.name\n    evacuee_1.save()\n\nif doc.evacuee_b:\n    evacuee_2 = frappe.get_doc(\"Evacuee\", doc.evacuee_b)\n    evacuee_2.arrangement_file = doc.name\n    evacuee_2.save()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-14 22:59:54.688500",
  "module": "rb",
  "name": "validate evacuee in arrangement file",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "# מניעת בחירה כפולה בטופס\nif doc.evacuee_a and doc.evacuee_b and doc.evacuee_a == doc.evacuee_b:\n    frappe.throw(\"לא ניתן לבחור את אותו מתפנה פעמיים.\")\n\n# בדיקת מתפנה ראשון\nif doc.evacuee_a:\n    evacuee_1 = frappe.get_doc(\"Evacuee\", doc.evacuee_a)\n    if evacuee_1.arrangement_file and evacuee_1.arrangement_file != doc.name:\n        frappe.throw(f\"המתפנה {evacuee_1.full_name} כבר משוייך לתיק הסדרה אחר ({evacuee_1.arrangement_file})\")\n\n# בדיקת מתפנה שני\nif doc.evacuee_b:\n    evacuee_2 = frappe.get_doc(\"Evacuee\", doc.evacuee_b)\n    if evacuee_2.arrangement_file and evacuee_2.arrangement_file != doc.name:\n        frappe.throw(f\"המתפנה {evacuee_2.full_name} כבר משוייך לתיק הסדרה אחר ({evacuee_2.arrangement_file})\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-17 11:57:20.906231",
  "module": "rb",
  "name": "create evacuee after created lead",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "# רק אם lead חדש ואין כבר evacuee שמקושר אליו\nif not frappe.db.exists(\"Evacuee\", {\"lead\": doc.name}):\n    evacuee = frappe.new_doc(\"Evacuee\")\n    evacuee.first_name = doc.first_name\n    evacuee.last_name = doc.last_name\n    evacuee.identification_number = doc.custom_identification_number\n    evacuee.date_of_birth = doc.date_of_birth\n    evacuee.cluster = doc.custom_cluster\n    evacuee.lead = doc.name  # נדרש שיהיה שדה Link ל־Lead בטופס Evacuee\n    evacuee.insert()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-16 22:42:07.819006",
  "module": "rb",
  "name": "after created customer from lead update evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "if doc.lead_name:\n    # ננסה למצוא את ה-Evacuee שמחובר ל-lead הזה\n    evacuee = frappe.get_all(\n        \"Evacuee\",\n        filters={\"lead\": doc.lead_name},\n        fields=[\"name\"]\n    )\n    if evacuee:\n        evacuee_doc = frappe.get_doc(\"Evacuee\", evacuee[0].name)\n        evacuee_doc.customer = doc.name\n        evacuee_doc.save()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-17 11:57:02.580671",
  "module": "rb",
  "name": "check lead before convert to customer",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "# רק אם ה-lead הומר ללקוח או שבוצעה פעולה שמרמזת על כך\nis_converting = (\n    doc.status == \"Converted\" or \n    frappe.db.exists(\"Customer\", {\"lead_name\": doc.name})\n)\n\n# השדות החובה שאתה רוצה לוודא\nrequired_fields = {\n    \"cluster\": \"Cluster\",\n    \"date_of_birth\": \"Date of Birth\",\n    \"identification_number\": \"Identification Number\"\n}\n\nif is_converting:\n    missing = [label for fieldname, label in required_fields.items() if not doc.get(fieldname)]\n    if missing:\n        frappe.throw(f\"חסרים שדות כדי להמיר את הליד ללקוח: {', '.join(missing)}\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-16 23:21:37.085948",
  "module": "rb",
  "name": "set full name in evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Evacuee",
  "script": "doc.full_name = f\"{doc.first_name or ''} {doc.last_name or ''}\".strip()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-18 14:11:05.354879",
  "module": "rb",
  "name": "validate phone number evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Evacuee",
  "script": "# שלבים:\n# - הסרת תווים שאינם ספרות\n# - בדיקה אם יש 10 ספרות\n# - עיצוב לפורמט xxx-xxx-xxxx\n\nif not doc.phone_number:\n    frappe.throw(\"יש להזין מספר טלפון\")\n\n# הסר תווים לא מספריים (רק ספרות נשארות)\ndigits = ''.join([c for c in doc.phone_number if c.isdigit()])\n\nif len(digits) != 10:\n    frappe.throw(\"מספר הטלפון חייב להכיל 10 ספרות בדיוק\" + \"\\nבפורמט xxx-xxx-xxxx\")\n\n# הפורמט הסופי: xxx-xxx-xxxx\ndoc.phone_number = f\"{digits[:3]}-{digits[3:6]}-{digits[6:]}\"\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Hourly",
  "modified": "2025-07-20 09:47:40.684131",
  "module": "rb",
  "name": "calculate nested estimate and actual costs in task",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\n# Server Script: סכימת Estimated Cost ו-Actual Cost ממשימות בנות אל תוך משימת-אב\n# Script Type: Scheduled\n# Frequency: Daily (או כל תדירות אחרת לפי הצורך)\n\ndef update_parent_costs():\n    from frappe import db\n    from frappe.utils import flt\n\n    # שלוף את כל משימות האב (is_group = 1)\n    parent_tasks = db.get_all(\"Task\", filters={\"is_group\": 1}, fields=[\"name\"])\n\n    for parent in parent_tasks:\n        # שלוף את המשימות הבנות הישירות\n        children = db.get_all(\"Task\", filters={\"parent_task\": parent.name}, fields=[\"custom_estimated_cost\", \"custom_actual_cost\"])\n\n        total_estimated = sum(flt(child.custom_estimated_cost) for child in children)\n        total_actual = sum(flt(child.custom_actual_cost) for child in children)\n\n        # עדכן את משימת האב\n        db.set_value(\"Task\", parent.name, {\n            \"custom_estimated_cost\": total_estimated,\n            \"custom_actual_cost\": total_actual\n        })\n\nupdate_parent_costs()\n",
  "script_type": "Scheduler Event"
 }
]