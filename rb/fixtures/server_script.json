[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-14 22:12:28.996942",
  "module": "rb",
  "name": "sync arrangement to evacuees",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "if doc.evacuee_a:\n    evacuee_1 = frappe.get_doc(\"Evacuee\", doc.evacuee_a)\n    evacuee_1.arrangement_file = doc.name\n    evacuee_1.save()\n\nif doc.evacuee_b:\n    evacuee_2 = frappe.get_doc(\"Evacuee\", doc.evacuee_b)\n    evacuee_2.arrangement_file = doc.name\n    evacuee_2.save()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-14 22:59:54.688500",
  "module": "rb",
  "name": "validate evacuee in arrangement file",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "# מניעת בחירה כפולה בטופס\nif doc.evacuee_a and doc.evacuee_b and doc.evacuee_a == doc.evacuee_b:\n    frappe.throw(\"לא ניתן לבחור את אותו מתפנה פעמיים.\")\n\n# בדיקת מתפנה ראשון\nif doc.evacuee_a:\n    evacuee_1 = frappe.get_doc(\"Evacuee\", doc.evacuee_a)\n    if evacuee_1.arrangement_file and evacuee_1.arrangement_file != doc.name:\n        frappe.throw(f\"המתפנה {evacuee_1.full_name} כבר משוייך לתיק הסדרה אחר ({evacuee_1.arrangement_file})\")\n\n# בדיקת מתפנה שני\nif doc.evacuee_b:\n    evacuee_2 = frappe.get_doc(\"Evacuee\", doc.evacuee_b)\n    if evacuee_2.arrangement_file and evacuee_2.arrangement_file != doc.name:\n        frappe.throw(f\"המתפנה {evacuee_2.full_name} כבר משוייך לתיק הסדרה אחר ({evacuee_2.arrangement_file})\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-17 11:57:20.906231",
  "module": "rb",
  "name": "create evacuee after created lead",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "# רק אם lead חדש ואין כבר evacuee שמקושר אליו\nif not frappe.db.exists(\"Evacuee\", {\"lead\": doc.name}):\n    evacuee = frappe.new_doc(\"Evacuee\")\n    evacuee.first_name = doc.first_name\n    evacuee.last_name = doc.last_name\n    evacuee.identification_number = doc.custom_identification_number\n    evacuee.date_of_birth = doc.date_of_birth\n    evacuee.cluster = doc.custom_cluster\n    evacuee.lead = doc.name  # נדרש שיהיה שדה Link ל־Lead בטופס Evacuee\n    evacuee.insert()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-16 22:42:07.819006",
  "module": "rb",
  "name": "after created customer from lead update evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "if doc.lead_name:\n    # ננסה למצוא את ה-Evacuee שמחובר ל-lead הזה\n    evacuee = frappe.get_all(\n        \"Evacuee\",\n        filters={\"lead\": doc.lead_name},\n        fields=[\"name\"]\n    )\n    if evacuee:\n        evacuee_doc = frappe.get_doc(\"Evacuee\", evacuee[0].name)\n        evacuee_doc.customer = doc.name\n        evacuee_doc.save()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-17 11:57:02.580671",
  "module": "rb",
  "name": "check lead before convert to customer",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "# רק אם ה-lead הומר ללקוח או שבוצעה פעולה שמרמזת על כך\nis_converting = (\n    doc.status == \"Converted\" or \n    frappe.db.exists(\"Customer\", {\"lead_name\": doc.name})\n)\n\n# השדות החובה שאתה רוצה לוודא\nrequired_fields = {\n    \"cluster\": \"Cluster\",\n    \"date_of_birth\": \"Date of Birth\",\n    \"identification_number\": \"Identification Number\"\n}\n\nif is_converting:\n    missing = [label for fieldname, label in required_fields.items() if not doc.get(fieldname)]\n    if missing:\n        frappe.throw(f\"חסרים שדות כדי להמיר את הליד ללקוח: {', '.join(missing)}\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-16 23:21:37.085948",
  "module": "rb",
  "name": "set full name in evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Evacuee",
  "script": "doc.full_name = f\"{doc.first_name or ''} {doc.last_name or ''}\".strip()\n",
  "script_type": "DocType Event"
 }
]